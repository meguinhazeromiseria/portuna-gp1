name: ðŸ¤– Scrapers - Grupo 1

on:
  # ExecuÃ§Ã£o manual com escolha de categoria e fonte
  workflow_dispatch:
    inputs:
      categoria:
        description: 'Categoria'
        required: true
        type: choice
        options:
          - veiculos
          - tecnologia
          - bens_consumo
          - eletrodomesticos
          - todas
      fonte:
        description: 'Fonte'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - sodre
          - megaleiloes
          - superbid
  
  # Cron automÃ¡tico
  schedule:
    # VeÃ­culos: 4x/dia (0h, 6h, 12h, 18h UTC)
    - cron: '0 0,6,12,18 * * *'

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install requests playwright beautifulsoup4
          playwright install chromium
          playwright install-deps
      
      - name: Test Connection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd scrapers
          python supabase_client.py
      
      # ============================================================
      # WORKFLOW DISPATCH (manual)
      # ============================================================
      - name: Run Selected Category
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.categoria != 'todas'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd scrapers
          CATEGORIA="${{ github.event.inputs.categoria }}"
          FONTE="${{ github.event.inputs.fonte }}"
          
          echo "======================================"
          echo "ðŸŽ¯ EXECUTANDO: $CATEGORIA"
          echo "======================================"
          echo "ðŸ“… InÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‡§ðŸ‡· HorÃ¡rio Brasil: $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S BRT')"
          echo "ðŸ“¦ Fonte: $FONTE"
          echo "======================================"
          echo ""
          
          START=$(date +%s)
          
          python ${CATEGORIA}.py --fonte $FONTE
          
          EXIT_CODE=$?
          END=$(date +%s)
          DURATION=$(( (END - START) / 60 ))
          
          echo ""
          echo "======================================"
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… $CATEGORIA CONCLUÃDO em ${DURATION} minutos"
          else
            echo "âŒ $CATEGORIA FALHOU (cÃ³digo $EXIT_CODE) apÃ³s ${DURATION} minutos"
          fi
          echo "ðŸ• TÃ©rmino: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "======================================"
          
          exit $EXIT_CODE
      
      - name: Run All Categories
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.categoria == 'todas'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd scrapers
          FONTE="${{ github.event.inputs.fonte }}"
          
          echo "======================================"
          echo "ðŸš€ EXECUTANDO TODAS AS CATEGORIAS"
          echo "======================================"
          echo "ðŸ“… InÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‡§ðŸ‡· HorÃ¡rio Brasil: $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S BRT')"
          echo "ðŸ“¦ Fonte: $FONTE"
          echo "======================================"
          echo ""
          
          START=$(date +%s)
          FAILED=0
          
          for CAT in veiculos tecnologia bens_consumo eletrodomesticos; do
            echo ""
            echo "=================================================="
            echo "ðŸŽ¯ EXECUTANDO: $CAT"
            echo "=================================================="
            
            if python ${CAT}.py --fonte $FONTE; then
              echo "âœ… $CAT concluÃ­do"
            else
              echo "âŒ $CAT falhou"
              FAILED=$((FAILED + 1))
            fi
            
            echo ""
          done
          
          END=$(date +%s)
          DURATION=$(( (END - START) / 60 ))
          
          echo "======================================"
          echo "ðŸ“Š RESUMO FINAL"
          echo "======================================"
          echo "â±ï¸  DuraÃ§Ã£o total: ${DURATION} minutos"
          echo "âŒ Falhas: $FAILED/4"
          echo "ðŸ• TÃ©rmino: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "======================================"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
      
      # ============================================================
      # CRON (automÃ¡tico)
      # ============================================================
      - name: Run Cron (VeÃ­culos)
        if: github.event_name == 'schedule'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd scrapers
          
          echo "======================================"
          echo "â° CRON: VEÃCULOS"
          echo "======================================"
          echo "ðŸ“… InÃ­cio: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‡§ðŸ‡· HorÃ¡rio Brasil: $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S BRT')"
          echo "ðŸ“¦ Fonte: all"
          echo "======================================"
          echo ""
          
          START=$(date +%s)
          
          python veiculos.py --fonte all
          
          EXIT_CODE=$?
          END=$(date +%s)
          DURATION=$(( (END - START) / 60 ))
          
          echo ""
          echo "======================================"
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… VEÃCULOS CONCLUÃDO em ${DURATION} minutos"
          else
            echo "âŒ VEÃCULOS FALHOU (cÃ³digo $EXIT_CODE) apÃ³s ${DURATION} minutos"
          fi
          echo "ðŸ• TÃ©rmino: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "======================================"
          
          exit $EXIT_CODE
      
      # ============================================================
      # ARTIFACTS
      # ============================================================
      - name: Upload Data on Success
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: dados-${{ github.run_number }}
          path: scrapers/*_data/*.json
          retention-days: 3
      
      - name: Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-erro-${{ github.run_number }}
          path: |
            scrapers/*_data/*.json
            scrapers/*.log
          retention-days: 7
      
      # ============================================================
      # SUMMARY
      # ============================================================
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– Scrapers - Grupo 1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Modo:** Manual" >> $GITHUB_STEP_SUMMARY
            echo "**Categoria:** ${{ github.event.inputs.categoria }}" >> $GITHUB_STEP_SUMMARY
            echo "**Fonte:** ${{ github.event.inputs.fonte }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Modo:** Cron (automÃ¡tico)" >> $GITHUB_STEP_SUMMARY
            echo "**Categoria:** veiculos" >> $GITHUB_STEP_SUMMARY
            echo "**Fonte:** all" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio UTC:** $(date -u '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**HorÃ¡rio Brasil:** $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Scraping concluÃ­do com sucesso!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Falhou â€“ veja os logs para detalhes." >> $GITHUB_STEP_SUMMARY
          fi